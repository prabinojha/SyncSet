<!DOCTYPE html>
<html>
<%- include('includes/head', {title: title}) %>

    <body class="<%= domainData && domainData.theme === 'dark' ? 'dark-theme' : 'light-theme' %>">
        <div class="subdomain-container">
            <div class="subdomain-content-section">
                <h1 id="subdomain-title">
                    <%= title %>
                </h1>
                <p id="subdomain-description">
                    <%= description %>
                </p>

                <div class="subdomain-calendar-section">
                    <div class="subdomain-calendar-grid">
                        <div class="subdomain-calendar-container">
                            <div class="subdomain-calendar-header">
                                <button id="subdomain-prevMonth" class="subdomain-calendar-nav-btn">&lt;</button>
                                <h2 id="subdomain-currentMonth">Month Year</h2>
                                <button id="subdomain-nextMonth" class="subdomain-calendar-nav-btn">&gt;</button>
                            </div>
                            <div class="subdomain-calendar-body">
                                <div class="subdomain-weekdays"></div>
                                <div class="subdomain-days"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="subdomain-services-grid">
                    <% if (services && services.length> 0) { %>
                        <% services.forEach(service=> { %>
                            <div class="subdomain-service-item" data-service-id="<%= service.id %>">
                                <h2>
                                    <%= service.title %>
                                </h2>
                                <p class="subdomain-service-description">
                                    <%= service.description %>
                                </p>
                                <div class="subdomain-service-details">
                                    <span>
                                        $<%= service.cost %> | <%= service.duration %> minutes
                                    </span>
                                </div>
                                <p class="subdomain-service-location">
                                    <%= service.location %>
                                </p>

                                <!-- Add time slots container -->
                                <div class="service-time-slots" style="display: none;">
                                    <div class="time-slots-grid"></div>
                                </div>
                            </div>
                            <% }); %>
                                <% } %>
                </div>
                <div class="subdomain-footer">
                    <button class="subdomain-cta-button" disabled>Select time and service</button>
                    <div class="subdomain-powered-by">powered by syncset.xyz</div>
                </div>
            </div>
        </div>

        <script>
            const services = JSON.parse('<%- JSON.stringify(services) %>');

            window.addEventListener('message', (event) => {
                if (event.data.type === 'updatePreview') {
                    const { title, description, theme } = event.data.data;

                    if (title) document.getElementById('subdomain-title').textContent = title;
                    if (description) document.getElementById('subdomain-description').textContent = description;

                    document.body.className = theme === 'dark' ? 'dark-theme' : 'light-theme';
                }
            });

            const calendar = {
                currentDate: new Date(),
                selectedDate: null,

                init() {
                    this.setupCalendarControls();
                    this.renderCalendar();
                },

                setupCalendarControls() {
                    document.getElementById('subdomain-prevMonth').addEventListener('click', () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                        this.renderCalendar();
                    });

                    document.getElementById('subdomain-nextMonth').addEventListener('click', () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                        this.renderCalendar();
                    });
                },

                renderCalendar() {
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth();

                    const monthNames = ["January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];
                    document.getElementById('subdomain-currentMonth').textContent = `${monthNames[month]} ${year}`;

                    const daysGrid = document.querySelector('.subdomain-days');
                    daysGrid.innerHTML = '';

                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);

                    for (let i = 0; i < firstDay.getDay(); i++) {
                        daysGrid.appendChild(this.createDayElement(''));
                    }

                    for (let day = 1; day <= lastDay.getDate(); day++) {
                        const dayElement = this.createDayElement(day);
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        
                        const currentDate = new Date(dateString);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        if (currentDate < today) {
                            dayElement.classList.add('disabled');
                        } else {
                            dayElement.dataset.date = dateString;
                            dayElement.addEventListener('click', () => this.selectDate(dateString));
                        }

                        if (this.isToday(year, month, day)) {
                            dayElement.classList.add('today');
                        }
                        
                        daysGrid.appendChild(dayElement);
                    }
                },

                createDayElement(content) {
                    const div = document.createElement('div');
                    div.className = 'subdomain-day';
                    div.textContent = content;
                    return div;
                },

                isToday(year, month, day) {
                    const today = new Date();
                    return today.getFullYear() === year &&
                        today.getMonth() === month &&
                        today.getDate() === day;
                },

                selectDate: async function(dateString) {
                    const selectedDate = new Date(dateString);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (selectedDate < today) {
                        return;
                    }

                    this.selectedDate = dateString;
                    document.querySelectorAll('.subdomain-day').forEach(day => {
                        day.classList.remove('selected');
                        if (day.dataset.date === dateString) {
                            day.classList.add('selected');
                        }
                    });

                    // Clear any previously selected time slots and update button
                    document.querySelectorAll('.time-slot').forEach(slot => {
                        slot.classList.remove('selected');
                    });
                    updateBookButton();

                    // Fetch and update time slots with booking data
                    await this.fetchAndUpdateTimeSlots(dateString);
                },

                fetchAndUpdateTimeSlots: async function(dateString) {
                    try {
                        const subdomain = window.location.pathname.split('/')[1];
                        const response = await fetch(`/api/bookings/${subdomain}/${dateString}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const bookings = await response.json();

                        // Create a timeline of all booked slots
                        const bookedRanges = createBookedTimeline(bookings);

                        document.querySelectorAll('.subdomain-service-item').forEach(serviceCard => {
                            const serviceId = serviceCard.dataset.serviceId;
                            const service = services.find(s => s.id === serviceId);
                            const slotsContainer = serviceCard.querySelector('.service-time-slots');
                            const slotsGrid = serviceCard.querySelector('.time-slots-grid');

                            // Generate time slots considering all bookings
                            const timeSlots = generateTimeSlots(
                                service.availability?.startTime || '09:00',
                                service.availability?.endTime || '17:00',
                                service.duration || 60,
                                bookedRanges
                            );

                            // Render time slots
                            slotsGrid.innerHTML = timeSlots.map(slot => `
                                <div class="time-slot${slot.booked ? ' booked' : ''}" 
                                     data-time="${slot.time}"
                                     ${slot.booked ? 'disabled' : ''}>
                                    ${formatTime(slot.time)}
                                </div>
                            `).join('');

                            slotsContainer.style.display = 'block';

                            // Add click handlers for time slots
                            slotsGrid.querySelectorAll('.time-slot:not(.booked)').forEach(slot => {
                                slot.addEventListener('click', () => {
                                    document.querySelectorAll('.time-slot').forEach(s => 
                                        s.classList.remove('selected'));
                                    slot.classList.add('selected');
                                    updateBookButton();
                                });
                            });
                        });
                    } catch (error) {
                        console.error('Error fetching bookings:', error);
                        document.querySelectorAll('.service-time-slots').forEach(container => {
                            container.style.display = 'none';
                        });
                    }
                }
            };

            // Helper function to create a timeline of booked slots
            function createBookedTimeline(bookings) {
                const bookedRanges = [];
                
                bookings.forEach(booking => {
                    const startMinutes = timeToMinutes(booking.time);
                    const endMinutes = startMinutes + parseInt(booking.duration);
                    
                    bookedRanges.push({
                        start: startMinutes,
                        end: endMinutes
                    });
                });
                
                return bookedRanges;
            }

            // Convert time string to minutes since start of day
            function timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            // Convert minutes to time string
            function minutesToTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
            }

            function generateTimeSlots(startTime, endTime, serviceDuration, bookedRanges) {
                const slots = [];
                const startMinutes = timeToMinutes(startTime);
                const endMinutes = timeToMinutes(endTime);
                const INTERVAL = 30; // Fixed 30-minute intervals
                
                // Get current time if it's today
                const now = new Date();
                const isToday = calendar.selectedDate === now.toISOString().split('T')[0];
                const currentMinutes = isToday ? now.getHours() * 60 + now.getMinutes() : 0;
                // Add 60 minutes (1 hour) buffer for today's bookings
                const minimumBookingTime = isToday ? currentMinutes + 60 : 0;
                
                for (let currentTime = startMinutes; currentTime < endMinutes; currentTime += INTERVAL) {
                    const slotEndTime = currentTime + parseInt(serviceDuration);
                    
                    // Check if this slot would extend beyond the end time
                    const exceedsEndTime = slotEndTime > endMinutes;
                    
                    // Check if the slot is in the past (including 1-hour buffer)
                    const isPastTime = isToday && currentTime < minimumBookingTime;
                    
                    // Check if this slot overlaps with any booked range
                    const isBooked = bookedRanges.some(range => {
                        return (currentTime >= range.start && currentTime < range.end) || 
                               (slotEndTime > range.start && slotEndTime <= range.end) ||
                               (currentTime <= range.start && slotEndTime >= range.end);
                    });
                    
                    slots.push({
                        time: minutesToTime(currentTime),
                        booked: isBooked || exceedsEndTime || isPastTime // Mark as booked if it's past time or exceeds end time
                    });
                }
                
                return slots;
            }

            function formatTime(time) {
                return time;
            }

            function updateBookButton() {
                const selectedSlot = document.querySelector('.time-slot.selected');
                const selectedDay = document.querySelector('.subdomain-day.selected');
                const bookButton = document.querySelector('.subdomain-cta-button');

                if (selectedSlot && selectedDay) {
                    bookButton.removeAttribute('disabled');
                    bookButton.textContent = 'Schedule now';
                } else {
                    bookButton.setAttribute('disabled', '');
                    bookButton.textContent = 'Select time and service';
                }
            }

            // Initialize calendar when DOM is loaded
            document.addEventListener('DOMContentLoaded', () => {
                calendar.init();
            });

            // Fix the booking button click handler
            document.querySelector('.subdomain-cta-button').addEventListener('click', () => {
                const selectedSlot = document.querySelector('.time-slot.selected');
                const selectedDay = document.querySelector('.subdomain-day.selected');
                const selectedService = selectedSlot.closest('.subdomain-service-item');
                const service = services.find(s => s.id === selectedService.dataset.serviceId);

                // Store booking details in session storage
                const bookingDetails = {
                    date: selectedDay.dataset.date,
                    time: selectedSlot.dataset.time,
                    serviceId: service.id,
                    serviceName: service.title,
                    cost: service.cost,
                    duration: service.duration
                };
                sessionStorage.setItem('pendingBooking', JSON.stringify(bookingDetails));

                // Get the current subdomain from the URL
                const subdomain = window.location.pathname.split('/')[1];
                
                // Redirect to booking confirmation page with proper path
                window.location.href = `/${subdomain}/confirm-booking`;
            });
        </script>
    </body>

</html>